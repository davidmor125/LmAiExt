<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בדיקת כפתור סיכום - צעד אחר צעד</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f8f9fa;
            margin: 0;
            padding: 20px;
            direction: rtl;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .step {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            position: relative;
        }
        .step.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .step.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .step.active {
            border-color: #007bff;
            background: #e3f2fd;
        }
        .step-number {
            position: absolute;
            top: -10px;
            right: 20px;
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .step.success .step-number {
            background: #28a745;
        }
        .step.error .step-number {
            background: #dc3545;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .text-area {
            background: #f8f9fa;
            padding: 15px;
            border: 2px dashed #dee2e6;
            border-radius: 5px;
            margin: 10px 0;
            user-select: text;
            cursor: text;
            min-height: 60px;
        }
        .text-area.selected {
            background: #fff3cd;
            border-color: #ffc107;
        }
        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        .status.waiting {
            background: #ffc107;
            color: #856404;
        }
        .status.success {
            background: #28a745;
            color: white;
        }
        .status.error {
            background: #dc3545;
            color: white;
        }
        h1 {
            color: #007bff;
            text-align: center;
        }
        h3 {
            margin-top: 0;
            color: #495057;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 בדיקת כפתור הסיכום - צעד אחר צעד</h1>
        
        <div class="warning">
            <strong>⚠️ הוראות חשובות:</strong><br>
            1. וודא שהתוסף Better Me מותקן ופעיל<br>
            2. הגדר את ה-AI API (LMStudio/Ollama) בהגדרות התוסף<br>
            3. הרץ את הבדיקות לפי הסדר
        </div>

        <!-- Step 1 -->
        <div class="step" id="step1">
            <div class="step-number">1</div>
            <h3>בדיקת התוסף</h3>
            <p>בודק אם התוסף Better Me נטען ופועל תקין</p>
            <button class="button" id="btn-step1">בדוק התוסף</button>
            <span class="status waiting" id="status1">ממתין</span>
            <div class="result-box" id="result1" style="display: none;"></div>
        </div>

        <!-- Step 2 -->
        <div class="step" id="step2">
            <div class="step-number">2</div>
            <h3>בדיקת הגדרות AI</h3>
            <p>בודק אם הגדרות ה-AI מוגדרות נכון</p>
            <button class="button" id="btn-step2" disabled>בדוק הגדרות</button>
            <span class="status waiting" id="status2">ממתין</span>
            <div class="result-box" id="result2" style="display: none;"></div>
        </div>

        <!-- Step 3 -->
        <div class="step" id="step3">
            <div class="step-number">3</div>
            <h3>בדיקת חיבור AI</h3>
            <p>בודק אם יש חיבור פעיל לשרת ה-AI</p>
            <button class="button" id="btn-step3" disabled>בדוק חיבור</button>
            <span class="status waiting" id="status3">ממתין</span>
            <div class="result-box" id="result3" style="display: none;"></div>
        </div>

        <!-- Step 4 -->
        <div class="step" id="step4">
            <div class="step-number">4</div>
            <h3>הפעלת התוסף</h3>
            <p>מפעיל את התוסף ומציג את הממשק</p>
            <button class="button" id="btn-step4" disabled>הפעל תוסף</button>
            <span class="status waiting" id="status4">ממתין</span>
            <div class="result-box" id="result4" style="display: none;"></div>
        </div>

        <!-- Step 5 -->
        <div class="step" id="step5">
            <div class="step-number">5</div>
            <h3>בחירת טקסט</h3>
            <p>בחר את הטקסט הבא ובדוק אם מופיע תפריט הקונטקסט:</p>
            <div class="text-area" id="sample-text">
                זהו טקסט לדוגמה לבדיקת פונקציית הסיכום. הטקסט כולל מספר משפטים ופסקאות 
                כדי לוודא שיש מספיק תוכן לסיכום מקיף. אנחנו בודקים שהתוסף Better Me 
                מזהה נכון את הטקסט הנבחר ומציג את כפתור הסיכום בתפריט הקונטקסט הצף. 
                לאחר הלחיצה על כפתור הסיכום, אמורה להופיע חלונית הסיכום עם התוצאה מהמודל AI.
            </div>
            <button class="button" id="btn-step5" disabled>סמלץ בחירה</button>
            <span class="status waiting" id="status5">ממתין</span>
            <div class="result-box" id="result5" style="display: none;"></div>
        </div>

        <!-- Step 6 -->
        <div class="step" id="step6">
            <div class="step-number">6</div>
            <h3>בדיקת כפתור הסיכום</h3>
            <p>בודק ישירות את פונקציית הסיכום</p>
            <button class="button" id="btn-step6" disabled>בדוק סיכום</button>
            <span class="status waiting" id="status6">ממתין</span>
            <div class="result-box" id="result6" style="display: none;"></div>
        </div>

    </div>

    <script>
        // Global variables
        let currentStep = 1;
        let extensionReady = false;
        let settingsValid = false;
        let aiConnected = false;
        let extensionActive = false;

        // Helper functions
        function setStepStatus(step, status, message) {
            const stepEl = document.getElementById(`step${step}`);
            const statusEl = document.getElementById(`status${step}`);
            const resultEl = document.getElementById(`result${step}`);
            
            stepEl.className = `step ${status}`;
            statusEl.className = `status ${status}`;
            statusEl.textContent = status === 'success' ? 'הושלם' : status === 'error' ? 'שגיאה' : 'ממתין';
            
            if (message) {
                resultEl.textContent = message;
                resultEl.style.display = 'block';
            }
            
            // Enable next step if current step succeeded
            if (status === 'success' && step < 6) {
                document.getElementById(`btn-step${step + 1}`).disabled = false;
            }
        }

        function log(step, message) {
            console.log(`Step ${step}: ${message}`);
            const resultEl = document.getElementById(`result${step}`);
            resultEl.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            resultEl.style.display = 'block';
            resultEl.scrollTop = resultEl.scrollHeight;
        }

        // Step 1: Check Extension
        document.getElementById('btn-step1').addEventListener('click', async () => {
            setStepStatus(1, 'active', '');
            log(1, 'בודק אם התוסף Better Me זמין...');
            
            try {
                if (typeof chrome === 'undefined' || !chrome.runtime || !chrome.runtime.id) {
                    throw new Error('Chrome Extension API לא זמין');
                }
                
                log(1, 'Chrome Extension API זמין ✓');
                log(1, `Extension ID: ${chrome.runtime.id}`);
                
                // Test communication with background script
                chrome.runtime.sendMessage({action: 'ping'}, (response) => {
                    if (chrome.runtime.lastError) {
                        log(1, `שגיאה בתקשורת: ${chrome.runtime.lastError.message}`);
                        setStepStatus(1, 'error', 'התוסף לא מגיב');
                    } else {
                        log(1, 'התוסף מגיב לבקשות ✓');
                        extensionReady = true;
                        setStepStatus(1, 'success', 'התוסף פועל תקין');
                    }
                });
                
            } catch (error) {
                log(1, `שגיאה: ${error.message}`);
                setStepStatus(1, 'error', error.message);
            }
        });

        // Step 2: Check Settings
        document.getElementById('btn-step2').addEventListener('click', async () => {
            setStepStatus(2, 'active', '');
            log(2, 'בודק הגדרות AI...');
            
            try {
                chrome.storage.sync.get(['apiUrl', 'modelName', 'apiType'], (settings) => {
                    log(2, `הגדרות נוכחיות:`);
                    log(2, `API URL: ${settings.apiUrl || 'לא מוגדר'}`);
                    log(2, `Model: ${settings.modelName || 'לא מוגדר'}`);
                    log(2, `Type: ${settings.apiType || 'לא מוגדר'}`);
                    
                    if (settings.apiUrl && settings.modelName) {
                        log(2, 'הגדרות AI מוגדרות ✓');
                        settingsValid = true;
                        setStepStatus(2, 'success', 'הגדרות תקינות');
                    } else {
                        log(2, 'הגדרות AI חסרות או שגויות');
                        setStepStatus(2, 'error', 'הגדרות AI לא מלאות');
                    }
                });
                
            } catch (error) {
                log(2, `שגיאה: ${error.message}`);
                setStepStatus(2, 'error', error.message);
            }
        });

        // Step 3: Test AI Connection
        document.getElementById('btn-step3').addEventListener('click', async () => {
            setStepStatus(3, 'active', '');
            log(3, 'בודק חיבור AI...');
            
            try {
                chrome.storage.sync.get(['apiUrl', 'apiType'], async (settings) => {
                    const apiUrl = settings.apiUrl || 'http://localhost:1234/v1/chat/completions';
                    const apiType = settings.apiType || 'lmstudio';
                    
                    log(3, `מנסה להתחבר ל-${apiType} על ${apiUrl}`);
                    
                    try {
                        const response = await fetch(apiUrl.replace('/chat/completions', '/models'), {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        
                        if (response.ok) {
                            log(3, `חיבור ל-${apiType} הצליח ✓`);
                            aiConnected = true;
                            setStepStatus(3, 'success', 'AI מחובר');
                        } else {
                            throw new Error(`HTTP ${response.status}`);
                        }
                    } catch (fetchError) {
                        log(3, `שגיאת חיבור: ${fetchError.message}`);
                        log(3, `וודא ש-${apiType} פועל על הכתובת הנכונה`);
                        setStepStatus(3, 'error', 'אין חיבור AI');
                    }
                });
                
            } catch (error) {
                log(3, `שגיאה: ${error.message}`);
                setStepStatus(3, 'error', error.message);
            }
        });

        // Step 4: Activate Extension
        document.getElementById('btn-step4').addEventListener('click', () => {
            setStepStatus(4, 'active', '');
            log(4, 'מפעיל את התוסף...');
            
            try {
                // Try to trigger extension activation
                chrome.runtime.sendMessage({action: 'activate'}, (response) => {
                    if (chrome.runtime.lastError) {
                        log(4, `שגיאה בהפעלה: ${chrome.runtime.lastError.message}`);
                        setStepStatus(4, 'error', 'שגיאה בהפעלת התוסף');
                    } else {
                        log(4, 'התוסף הופעל בהצלחה ✓');
                        
                        // Check if Better Me interface is visible
                        setTimeout(() => {
                            if (document.getElementById('betterme-bubble') || 
                                document.getElementById('betterme-overlay')) {
                                log(4, 'ממשק Better Me פעיל ✓');
                                extensionActive = true;
                                setStepStatus(4, 'success', 'התוסף פעיל');
                            } else {
                                log(4, 'ממשק Better Me לא נמצא - נסה ללחוץ על אייקון התוסף');
                                setStepStatus(4, 'error', 'ממשק לא פעיל');
                            }
                        }, 2000);
                    }
                });
                
            } catch (error) {
                log(4, `שגיאה: ${error.message}`);
                setStepStatus(4, 'error', error.message);
            }
        });

        // Step 5: Text Selection
        document.getElementById('btn-step5').addEventListener('click', () => {
            setStepStatus(5, 'active', '');
            log(5, 'מדמה בחירת טקסט...');
            
            const textEl = document.getElementById('sample-text');
            textEl.classList.add('selected');
            
            // Select the text
            const range = document.createRange();
            range.selectNodeContents(textEl);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            log(5, `טקסט נבחר: ${selection.toString().substring(0, 50)}...`);
            
            // Check for context menu
            setTimeout(() => {
                const contextMenu = document.querySelector('[id*="context"]') || 
                                 document.querySelector('[class*="context"]');
                
                if (contextMenu) {
                    log(5, 'תפריט קונטקסט זוהה ✓');
                    setStepStatus(5, 'success', 'תפריט קונטקסט פעיל');
                } else {
                    log(5, 'תפריט קונטקסט לא נמצא - בחר טקסט ידנית');
                    setStepStatus(5, 'error', 'אין תפריט קונטקסט');
                }
            }, 1500);
        });

        // Step 6: Test Summary Function
        document.getElementById('btn-step6').addEventListener('click', () => {
            setStepStatus(6, 'active', '');
            log(6, 'בודק פונקציית סיכום...');
            
            const testText = document.getElementById('sample-text').textContent;
            
            try {
                // Send summary request
                chrome.runtime.sendMessage({
                    action: 'summarize',
                    content: testText,
                    type: 'selection'
                });
                
                log(6, 'בקשת סיכום נשלחה ✓');
                
                // Listen for response
                const responseListener = (message) => {
                    log(6, `תגובה התקבלה: ${JSON.stringify(message)}`);
                    
                    if (message.action === 'displayResult' && message.type === 'summarize') {
                        log(6, 'סיכום הושלם בהצלחה ✓');
                        log(6, `תוצאה: ${message.result.substring(0, 100)}...`);
                        setStepStatus(6, 'success', 'סיכום פועל תקין!');
                        chrome.runtime.onMessage.removeListener(responseListener);
                    } else if (message.action === 'displayError') {
                        log(6, `שגיאת סיכום: ${message.error}`);
                        setStepStatus(6, 'error', `שגיאה: ${message.error}`);
                        chrome.runtime.onMessage.removeListener(responseListener);
                    }
                };
                
                chrome.runtime.onMessage.addListener(responseListener);
                
                // Timeout after 15 seconds
                setTimeout(() => {
                    chrome.runtime.onMessage.removeListener(responseListener);
                    log(6, 'אין תגובה לאחר 15 שניות');
                    setStepStatus(6, 'error', 'תם זמן הבדיקה');
                }, 15000);
                
            } catch (error) {
                log(6, `שגיאה: ${error.message}`);
                setStepStatus(6, 'error', error.message);
            }
        });

        // Initialize
        console.log('🚀 מערכת בדיקות אותחלה');
        console.log('📋 הרץ את הבדיקות לפי הסדר המספרי');
    </script>
</body>
</html>
