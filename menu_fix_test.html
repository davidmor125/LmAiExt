<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בדיקת תיקון בעיית התפריט הצף</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 30px;
            background: #f0f8ff;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .problem-description {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .fix-description {
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .test-area {
            background: #e3f2fd;
            border: 3px solid #2196f3;
            padding: 30px;
            border-radius: 12px;
            margin: 30px 0;
            font-size: 18px;
            line-height: 2;
            user-select: text;
        }
        .steps {
            background: #f8f9fa;
            border: 2px solid #6c757d;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        .console {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            height: 250px;
            overflow-y: auto;
            white-space: pre-wrap;
            direction: ltr;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 בדיקת תיקון - בעיית התפריט הצף</h1>
        
        <div class="problem-description">
            <h3>🚨 הבעיה שדווחה:</h3>
            <p><strong>"שאני לוחץ על התפריט הצף הוא נסגר ונפתח מחדש ולא נפתחת חלונית סיכום"</strong></p>
            <p>זה אומר שיש התנגשות בין event listeners שגורמת לתפריט להסתבך במקום לפתוח את הדיאלוג.</p>
        </div>

        <div class="fix-description">
            <h3>✅ התיקון שבוצע:</h3>
            <ul>
                <li>🛑 הוספת `stopImmediatePropagation()` לכפתור התפריט</li>
                <li>🛡️ מניעת text selection events על התפריט עצמו</li>
                <li>🎯 שיפור הלוגיקה של `handleMouseDown` - לא מסתיר אם לוחצים על התפריט</li>
                <li>📱 הוספת `user-select: none` לכפתור</li>
                <li>🔍 הוספת בדיקה ב-`handleTextSelection` למניעת אירועים מהתפריט</li>
            </ul>
        </div>

        <div class="steps">
            <h3>📋 צעדי בדיקה:</h3>
            <ol>
                <li><strong>בחר את הטקסט הכחול למטה</strong> - אמור להופיע תפריט צף</li>
                <li><strong>לחץ על "📄 סכם טקסט מסומן"</strong> - הדיאלוג אמור להיפתח מיד</li>
                <li><strong>בדוק שהתפריט לא נסגר ונפתח מחדש</strong></li>
                <li><strong>בדוק שהדיאלוג מציג את הטקסט הנכון</strong></li>
            </ol>
        </div>

        <div id="status" class="status info">מחכה לבדיקה...</div>

        <div class="test-area">
            <strong>🎯 בחר את הטקסט הזה לבדיקה:</strong><br><br>
            זהו טקסט ייעודי לבדיקת התיקון של התפריט הצף. כשתבחר את הטקסט הזה, 
            אמור להופיע תפריט צף עם כפתור "📄 סכם טקסט מסומן". לחיצה על הכפתור 
            אמורה לפתוח את דיאלוג הסיכום מיד, בלי שהתפריט ייסגר ויפתח מחדש. 
            זהו הבדיקה הקריטית לוודא שהתיקון עבד. אם הדיאלוג נפתח בהצלחה, 
            זה אומר שהבעיה נפתרה!
        </div>

        <div class="steps">
            <h3>🔍 מה לצפות:</h3>
            <div class="status success">✅ נכון: בחירת טקסט → תפריט צף → לחיצה → דיאלוג נפתח</div>
            <div class="status error">❌ שגוי: בחירת טקסט → תפריט צף → לחיצה → תפריט נסגר/נפתח מחדש</div>
        </div>

        <h3>📊 לוג אירועים:</h3>
        <div id="console" class="console">מחכה לאירועים...</div>
    </div>

    <script>
        let eventLog = [];
        const maxLogs = 30;

        // Console override to capture logs
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn
        };

        function addToEventLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            eventLog.push(`[${timestamp}] ${type}: ${message}`);
            if (eventLog.length > maxLogs) {
                eventLog = eventLog.slice(-maxLogs);
            }
            updateConsoleDisplay();
            
            // Also call original console
            originalConsole[type].apply(console, [message]);
        }

        console.log = (...args) => addToEventLog('LOG', args.join(' '));
        console.error = (...args) => addToEventLog('ERROR', args.join(' '));
        console.warn = (...args) => addToEventLog('WARN', args.join(' '));

        function updateConsoleDisplay() {
            document.getElementById('console').textContent = eventLog.join('\n');
            document.getElementById('console').scrollTop = document.getElementById('console').scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }

        // Monitor text selection
        let selectionCount = 0;
        document.addEventListener('mouseup', () => {
            setTimeout(() => {
                const selectedText = window.getSelection().toString().trim();
                if (selectedText.length > 10) {
                    selectionCount++;
                    console.log(`📝 Text selection #${selectionCount}: "${selectedText.substring(0, 40)}..."`);
                    updateStatus(`✅ טקסט נבחר (${selectedText.length} תווים) - מחכה לתפריט צף...`, 'success');
                    
                    // Check if menu appears
                    setTimeout(() => {
                        const menu = document.getElementById('betterme-floating-menu');
                        if (menu && menu.style.display === 'block') {
                            console.log('✅ Floating menu appeared after text selection');
                            updateStatus('✅ תפריט צף מופיע - עכשיו לחץ על "סכם טקסט מסומן"', 'success');
                        } else {
                            console.log('❌ Floating menu did not appear');
                            updateStatus('❌ תפריט צף לא מופיע', 'error');
                        }
                    }, 300);
                }
            }, 100);
        });

        // Monitor clicks on floating menu
        let menuClickCount = 0;
        document.addEventListener('click', (e) => {
            if (e.target.closest('#betterme-floating-menu')) {
                menuClickCount++;
                console.log(`🔥 Floating menu click #${menuClickCount} detected`);
                updateStatus('🔥 זוהתה לחיצה על התפריט - בודק אם נפתח דיאלוג...', 'warning');
                
                setTimeout(() => {
                    const dialog = document.getElementById('betterme-summary-dialog');
                    const overlay = document.getElementById('betterme-summary-overlay');
                    
                    if (dialog && overlay) {
                        console.log('✅ SUCCESS: Dialog opened after menu click!');
                        updateStatus('🎉 מעולה! הדיאלוג נפתח בהצלחה - התיקון עבד!', 'success');
                    } else {
                        console.log('❌ FAIL: Dialog did not open after menu click');
                        updateStatus('❌ דיאלוג לא נפתח - יש עדיין בעיה', 'error');
                    }
                }, 1000);
            }
        }, true);

        // Monitor if menu disappears and reappears (the original problem)
        let menuVisibilityCount = 0;
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    const menu = mutation.target;
                    if (menu.id === 'betterme-floating-menu') {
                        const isVisible = menu.style.display === 'block';
                        menuVisibilityCount++;
                        console.log(`👀 Menu visibility change #${menuVisibilityCount}: ${isVisible ? 'VISIBLE' : 'HIDDEN'}`);
                        
                        if (menuVisibilityCount > 2) {
                            console.log('⚠️ Warning: Menu visibility changed multiple times - possible issue');
                            updateStatus('⚠️ תפריט משנה נראות מספר פעמים - יכול להיות שיש בעיה', 'warning');
                        }
                    }
                }
            });
        });

        // Start observing when menu is created
        setTimeout(() => {
            const menu = document.getElementById('betterme-floating-menu');
            if (menu) {
                observer.observe(menu, { attributes: true, attributeFilter: ['style'] });
                console.log('👀 Started monitoring menu visibility changes');
            }
        }, 2000);

        // Initial status
        setTimeout(() => {
            console.log('🚀 Test page loaded - ready for testing');
            updateStatus('✅ דף נטען - בחר טקסט כחול למטה לבדיקה', 'info');
        }, 1000);
    </script>
</body>
</html>
