<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בדיקת כפתור הסיכום - פשוט</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
            direction: rtl;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #007bff;
            margin-top: 0;
        }
        .sample-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin: 10px 0;
            user-select: text;
            cursor: text;
        }
        .sample-text.selected {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
        }
        .status-indicator.active {
            background: #28a745;
            animation: pulse 1.5s infinite;
        }
        .status-indicator.error {
            background: #dc3545;
        }
        .status-indicator.inactive {
            background: #6c757d;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .log-console {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        .clear-logs {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 בדיקת כפתור הסיכום - מבחן פשוט</h1>
        <p>דף זה מאפשר לבדוק אם כפתור הסיכום עובד תקין לאחר התיקונים</p>

        <!-- Test 1: Extension Status -->
        <div class="test-section">
            <h3>🔍 בדיקה 1: סטטוס התוסף</h3>
            <p>בודק אם התוסף נטען ופועל:</p>
            <button class="test-button" id="check-extension">בדוק סטטוס תוסף</button>
            <span class="status-indicator inactive" id="extension-status"></span>
            <div class="result" id="extension-result"></div>
        </div>

        <!-- Test 2: Text Selection -->
        <div class="test-section">
            <h3>📝 בדיקה 2: בחירת טקסט וכפתור סיכום</h3>
            <p>בחר את הטקסט הבא ובדוק אם מופיע כפתור הסיכום:</p>
            <div class="sample-text" id="sample-text">
                זהו טקסט לדוגמה לבדיקת כפתור הסיכום. הטקסט כולל מספר משפטים כדי לוודא שיש מספיק תוכן לסיכום. 
                אנחנו בודקים שהתוסף מזהה נכון את הטקסט הנבחר ומציג את כפתור הסיכום בתפריט הקונטקסט הצף. 
                לאחר הלחיצה על הכפתור, אמורה להופיע חלונית הסיכום עם התוצאה מה-AI.
            </div>
            <button class="test-button" id="simulate-selection">סמלץ בחירת טקסט</button>
            <span class="status-indicator inactive" id="selection-status"></span>
            <div class="result" id="selection-result"></div>
        </div>

        <!-- Test 3: AI Connection -->
        <div class="test-section">
            <h3>🤖 בדיקה 3: חיבור AI</h3>
            <p>בודק אם ה-AI מחובר ומגיב:</p>
            <button class="test-button" id="test-ai">בדוק חיבור AI</button>
            <span class="status-indicator inactive" id="ai-status"></span>
            <div class="result" id="ai-result"></div>
        </div>

        <!-- Test 4: Summary Function -->
        <div class="test-section">
            <h3>📄 בדיקה 4: פונקציית הסיכום</h3>
            <p>בדיקה ישירה של פונקציית הסיכום:</p>
            <button class="test-button" id="test-summary">בדוק פונקציית סיכום</button>
            <span class="status-indicator inactive" id="summary-status"></span>
            <div class="result" id="summary-result"></div>
        </div>

        <!-- Console Log -->
        <div class="test-section">
            <h3>🔧 לוג בדיקות</h3>
            <button class="clear-logs" id="clear-logs">נקה לוג</button>
            <div class="log-console" id="log-console">אתחול מערכת הבדיקות...</div>
        </div>
    </div>

    <script>
        // Console logging system
        const logConsole = document.getElementById('log-console');
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;

        function addToLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('he-IL');
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
            logConsole.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        // Override console methods
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToLog(args.join(' '), 'info');
        };

        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addToLog(args.join(' '), 'error');
        };

        // Clear logs
        document.getElementById('clear-logs').addEventListener('click', () => {
            logConsole.textContent = 'לוג נוקה...\n';
        });

        // Helper functions
        function setStatus(elementId, status) {
            const element = document.getElementById(elementId);
            element.className = `status-indicator ${status}`;
        }

        function showResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
            element.textContent = message;
            element.style.display = 'block';
        }

        // Test 1: Extension Status
        document.getElementById('check-extension').addEventListener('click', async () => {
            console.log('🔍 בודק סטטוס התוסף...');
            setStatus('extension-status', 'active');
            
            try {
                if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.id) {
                    console.log('✅ Chrome extension API זמין');
                    console.log('📋 Extension ID:', chrome.runtime.id);
                    
                    // Check if extension is responsive
                    chrome.runtime.sendMessage({action: 'ping'}, (response) => {
                        if (chrome.runtime.lastError) {
                            console.error('❌ שגיאה בתקשורת עם התוסף:', chrome.runtime.lastError.message);
                            setStatus('extension-status', 'error');
                            showResult('extension-result', 'התוסף לא מגיב - נסה לטעון מחדש את הדף', false);
                        } else {
                            console.log('✅ התוסף פועל ומגיב');
                            setStatus('extension-status', 'active');
                            showResult('extension-result', 'התוסף פועל תקין!', true);
                        }
                    });
                } else {
                    throw new Error('Chrome extension API לא זמין');
                }
            } catch (error) {
                console.error('❌ שגיאה בבדיקת התוסף:', error.message);
                setStatus('extension-status', 'error');
                showResult('extension-result', `שגיאה: ${error.message}`, false);
            }
        });

        // Test 2: Text Selection Simulation
        document.getElementById('simulate-selection').addEventListener('click', () => {
            console.log('📝 מדמה בחירת טקסט...');
            setStatus('selection-status', 'active');
            
            const textElement = document.getElementById('sample-text');
            textElement.classList.add('selected');
            
            // Simulate text selection
            const range = document.createRange();
            range.selectNodeContents(textElement);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            console.log('✅ טקסט נבחר:', selection.toString().substring(0, 50) + '...');
            
            // Check if Better Me extension is active and can detect selection
            setTimeout(() => {
                if (document.getElementById('betterme-bubble') || document.getElementById('betterme-context-menu')) {
                    console.log('✅ תפריט הקונטקסט של Better Me זוהה');
                    setStatus('selection-status', 'active');
                    showResult('selection-result', 'תפריט הקונטקסט פעיל - חפש את כפתור הסיכום', true);
                } else {
                    console.log('⚠️ תפריט הקונטקסט לא זוהה - נסה להפעיל את התוסף');
                    setStatus('selection-status', 'error');
                    showResult('selection-result', 'תפריט הקונטקסט לא נמצא - הפעל את התוסף או בחר טקסט ידנית', false);
                }
            }, 1000);
        });

        // Test 3: AI Connection
        document.getElementById('test-ai').addEventListener('click', async () => {
            console.log('🤖 בודק חיבור AI...');
            setStatus('ai-status', 'active');
            
            try {
                // Send test message to background script
                chrome.runtime.sendMessage({
                    action: 'summarize',
                    content: 'טקסט לבדיקה',
                    type: 'test'
                });
                
                console.log('📤 הודעת בדיקה נשלחה ל-background script');
                
                // Listen for response
                const messageListener = (message) => {
                    console.log('📥 תגובה מ-background script:', message);
                    
                    if (message.action === 'displayResult') {
                        console.log('✅ AI מחובר ופועל');
                        setStatus('ai-status', 'active');
                        showResult('ai-result', 'AI מחובר ומגיב תקין!', true);
                        chrome.runtime.onMessage.removeListener(messageListener);
                    } else if (message.action === 'displayError') {
                        console.error('❌ שגיאת AI:', message.error);
                        setStatus('ai-status', 'error');
                        showResult('ai-result', `שגיאת AI: ${message.error}`, false);
                        chrome.runtime.onMessage.removeListener(messageListener);
                    }
                };
                
                chrome.runtime.onMessage.addListener(messageListener);
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    chrome.runtime.onMessage.removeListener(messageListener);
                    console.error('❌ אין תגובה מ-AI לאחר 10 שניות');
                    setStatus('ai-status', 'error');
                    showResult('ai-result', 'אין תגובה מ-AI - בדוק הגדרות API', false);
                }, 10000);
                
            } catch (error) {
                console.error('❌ שגיאה בבדיקת AI:', error.message);
                setStatus('ai-status', 'error');
                showResult('ai-result', `שגיאה: ${error.message}`, false);
            }
        });

        // Test 4: Summary Function Test
        document.getElementById('test-summary').addEventListener('click', () => {
            console.log('📄 בודק פונקציית סיכום...');
            setStatus('summary-status', 'active');
            
            const testText = document.getElementById('sample-text').textContent;
            
            try {
                // Send summarize request
                chrome.runtime.sendMessage({
                    action: 'summarize',
                    content: testText,
                    type: 'selection'
                });
                
                console.log('📤 בקשת סיכום נשלחה');
                
                // Listen for summary result
                const summaryListener = (message) => {
                    console.log('📥 תגובת סיכום:', message);
                    
                    if (message.action === 'displayResult' && message.type === 'summarize') {
                        console.log('✅ סיכום הושלם בהצלחה');
                        setStatus('summary-status', 'active');
                        showResult('summary-result', `סיכום התקבל: ${message.result.substring(0, 100)}...`, true);
                        chrome.runtime.onMessage.removeListener(summaryListener);
                    } else if (message.action === 'displayError') {
                        console.error('❌ שגיאה בסיכום:', message.error);
                        setStatus('summary-status', 'error');
                        showResult('summary-result', `שגיאת סיכום: ${message.error}`, false);
                        chrome.runtime.onMessage.removeListener(summaryListener);
                    }
                };
                
                chrome.runtime.onMessage.addListener(summaryListener);
                
                // Timeout after 15 seconds
                setTimeout(() => {
                    chrome.runtime.onMessage.removeListener(summaryListener);
                    console.error('❌ לא התקבל סיכום לאחר 15 שניות');
                    setStatus('summary-status', 'error');
                    showResult('summary-result', 'לא התקבל סיכום - בדוק חיבור AI', false);
                }, 15000);
                
            } catch (error) {
                console.error('❌ שגיאה בפונקציית סיכום:', error.message);
                setStatus('summary-status', 'error');
                showResult('summary-result', `שגיאה: ${error.message}`, false);
            }
        });

        // Initialize
        console.log('🚀 מערכת בדיקות הופעלה');
        console.log('📋 הוראות: הרץ כל בדיקה בסדר לאבחון בעיות');
        
    </script>
</body>
</html>
