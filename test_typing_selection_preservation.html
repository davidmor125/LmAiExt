<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בדיקת תיקון מתקדמת - שמירת טקסט בכתיבה</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            direction: rtl;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        h1 {
            color: #182857;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #182857, #667eea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .critical-test {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 10px 30px rgba(255,107,107,0.3);
        }
        .critical-test h2 {
            margin-top: 0;
            font-size: 1.8em;
        }
        .test-text {
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid #007bff;
            border-radius: 15px;
            padding: 30px;
            margin: 25px 0;
            font-size: 18px;
            line-height: 1.8;
            cursor: text;
            user-select: text;
            transition: all 0.3s ease;
            color: #333;
        }
        .test-text.selected {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            box-shadow: 0 8px 30px rgba(40,167,69,0.3);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.01); }
        }
        .status-panel {
            background: #000;
            color: #00ff00;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
        }
        .step-by-step {
            background: rgba(33, 150, 243, 0.1);
            border: 2px solid #2196F3;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
        }
        .step {
            background: white;
            border-right: 5px solid #007bff;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .step:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 15px rgba(0,123,255,0.2);
        }
        .step.current {
            border-right-color: #28a745;
            background: #d4edda;
        }
        .step.completed {
            border-right-color: #28a745;
            background: #d4edda;
            opacity: 0.7;
        }
        .step.failed {
            border-right-color: #dc3545;
            background: #f8d7da;
        }
        .real-time-monitor {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 10000;
            max-width: 300px;
        }
        .highlight {
            background: #ffeb3b;
            padding: 2px 6px;
            border-radius: 4px;
            color: #333;
            font-weight: bold;
        }
        .buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,123,255,0.4);
        }
    </style>
</head>
<body>
    <div class="real-time-monitor" id="monitor">
        <div><strong>מוניטור בזמן אמת</strong></div>
        <div>טקסט נבחר: <span id="monitor-text">לא</span></div>
        <div>אורך: <span id="monitor-length">0</span></div>
        <div>דיאלוג פתוח: <span id="monitor-dialog">לא</span></div>
        <div>שדה טקסט פעיל: <span id="monitor-textarea">לא</span></div>
        <div>סטטוס: <span id="monitor-status">ממתין</span></div>
    </div>

    <div class="container">
        <h1>🔥 בדיקה קריטית: שמירת טקסט בכתיבה</h1>
        
        <div class="critical-test">
            <h2>⚠️ בדיקה זו תוודא שהתיקון עובד במהלך הכתיבה!</h2>
            <p>זוהי הבדיקה המכרעת שתקבע אם הבעיה נפתרה לחלוטין.</p>
        </div>

        <div class="step-by-step">
            <h3>📋 שלבי הבדיקה המדויקים</h3>
            <div class="step" id="step1">
                <strong>שלב 1:</strong> בחר טקסט מהקטע למטה
            </div>
            <div class="step" id="step2">
                <strong>שלב 2:</strong> לחץ על "שאל Better Me" בתפריט הצף
            </div>
            <div class="step" id="step3">
                <strong>שלב 3:</strong> וודא שהטקסט נשאר מסומן אחרי פתיחת הדיאלוג
            </div>
            <div class="step" id="step4">
                <strong>שלב 4:</strong> לחץ על שדה הטקסט בדיאלוג
            </div>
            <div class="step" id="step5">
                <strong>שלב 5:</strong> התחל לכתוב שאלה
            </div>
            <div class="step" id="step6">
                <strong>שלב 6:</strong> בדוק שהטקסט עדיין מסומן במהלך הכתיבה!
            </div>
        </div>

        <div class="test-text" id="test-content">
            <strong>🎯 טקסט לבדיקה קריטית:</strong><br><br>
            זהו טקסט מיוחד לבדיקת התיקון החדש. <span class="highlight">בחר את המשפט הזה</span> 
            ולאחר מכן פתח את דיאלוג השאלות והתחל לכתוב. הטקסט צריך להישאר מסומן 
            לאורך כל התהליך, כולל במהלך הכתיבה בשדה הטקסט.
            
            <br><br>
            
            אם הטקסט נשאר מסומן גם כשאתה כותב בשדה הטקסט, המשמעות היא שהתיקון 
            הצליח לחלוטין! זה אומר שתוכל לשאול שאלות על חלקים ספציפיים מהדף 
            בלי לאבד את הקשר הויזואלי.
            
            <br><br>
            
            <span class="highlight">טקסט נוסף לבדיקה:</span> בחר גם את החלק הזה ונסה 
            את אותו התהליך. ככל שתבדוק יותר טקסטים, כך תהיה בטוח יותר שהתיקון עובד.
        </div>

        <div class="buttons">
            <button class="btn" onclick="selectTestText()">בחר טקסט אוטומטית</button>
            <button class="btn" onclick="clearSelection()">נקה בחירה</button>
            <button class="btn" onclick="startMonitoring()">התחל ניטור מתקדם</button>
            <button class="btn" onclick="stopMonitoring()">עצור ניטור</button>
        </div>

        <div class="status-panel" id="log">
            בדיקה אותחלה...\n
        </div>
    </div>

    <script>
        let monitoringActive = false;
        let monitorInterval = null;
        let currentStep = 1;
        let testStartTime = null;
        
        // Elements
        const monitorText = document.getElementById('monitor-text');
        const monitorLength = document.getElementById('monitor-length');
        const monitorDialog = document.getElementById('monitor-dialog');
        const monitorTextarea = document.getElementById('monitor-textarea');
        const monitorStatus = document.getElementById('monitor-status');
        const logPanel = document.getElementById('log');
        const testContent = document.getElementById('test-content');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString('he-IL');
            logPanel.textContent += `[${timestamp}] ${message}\n`;
            logPanel.scrollTop = logPanel.scrollHeight;
            console.log(message);
        }
        
        function updateMonitor() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            const hasDialog = document.getElementById('betterme-overlay') !== null;
            const hasTextarea = document.getElementById('betterme-question') !== null;
            const textareaFocused = hasTextarea && document.getElementById('betterme-question') === document.activeElement;
            
            monitorText.textContent = selectedText.length > 0 ? 'כן' : 'לא';
            monitorLength.textContent = selectedText.length;
            monitorDialog.textContent = hasDialog ? 'כן' : 'לא';
            monitorTextarea.textContent = textareaFocused ? 'כן' : 'לא';
            
            // Update step status
            updateStepStatus(selectedText.length > 0, hasDialog, textareaFocused);
            
            // Highlight test content if selected
            if (selectedText.length > 0) {
                testContent.classList.add('selected');
            } else {
                testContent.classList.remove('selected');
            }
            
            // Critical test: typing while text is selected
            if (hasDialog && textareaFocused && selectedText.length > 0) {
                monitorStatus.textContent = 'מצוין! טקסט נשמר בכתיבה';
                monitorStatus.style.color = '#00ff00';
                log('✅ SUCCESS: טקסט נשאר מסומן במהלך הכתיבה!');
            } else if (hasDialog && textareaFocused && selectedText.length === 0) {
                monitorStatus.textContent = 'בעיה: טקסט אבד בכתיבה';
                monitorStatus.style.color = '#ff0000';
                log('❌ PROBLEM: טקסט אבד במהלך הכתיבה');
            } else if (hasDialog && selectedText.length > 0) {
                monitorStatus.textContent = 'טוב: טקסט נשמר בדיאלוג';
                monitorStatus.style.color = '#ffff00';
            } else if (selectedText.length > 0) {
                monitorStatus.textContent = 'טקסט נבחר - פתח דיאלוג';
                monitorStatus.style.color = '#00ffff';
            } else {
                monitorStatus.textContent = 'ממתין לבחירת טקסט';
                monitorStatus.style.color = '#ffffff';
            }
        }
        
        function updateStepStatus(hasSelection, hasDialog, textareaFocused) {
            // Reset all steps
            for (let i = 1; i <= 6; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('current', 'completed', 'failed');
            }
            
            if (hasSelection) {
                document.getElementById('step1').classList.add('completed');
                if (hasDialog) {
                    document.getElementById('step2').classList.add('completed');
                    document.getElementById('step3').classList.add('completed');
                    if (textareaFocused) {
                        document.getElementById('step4').classList.add('completed');
                        document.getElementById('step5').classList.add('current');
                        // Check if typing preserves selection
                        const textarea = document.getElementById('betterme-question');
                        if (textarea && textarea.value.length > 0) {
                            if (hasSelection) {
                                document.getElementById('step5').classList.remove('current');
                                document.getElementById('step5').classList.add('completed');
                                document.getElementById('step6').classList.add('completed');
                                log('🎉 ALL STEPS COMPLETED SUCCESSFULLY!');
                            } else {
                                document.getElementById('step5').classList.add('failed');
                                document.getElementById('step6').classList.add('failed');
                            }
                        }
                    } else {
                        document.getElementById('step4').classList.add('current');
                    }
                } else {
                    document.getElementById('step2').classList.add('current');
                }
            } else {
                document.getElementById('step1').classList.add('current');
            }
        }
        
        function startMonitoring() {
            if (monitoringActive) return;
            
            monitoringActive = true;
            testStartTime = Date.now();
            log('🔍 התחל ניטור מתקדם');
            
            monitorInterval = setInterval(updateMonitor, 200); // Check every 200ms
            
            // Monitor typing in textarea
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === Node.ELEMENT_NODE && node.id === 'betterme-overlay') {
                            log('🎯 דיאלוג Better Me נפתח');
                            setTimeout(() => {
                                const textarea = document.getElementById('betterme-question');
                                if (textarea) {
                                    textarea.addEventListener('input', () => {
                                        log(`📝 משתמש כותב: "${textarea.value}"`);
                                        setTimeout(updateMonitor, 10);
                                    });
                                    
                                    textarea.addEventListener('focus', () => {
                                        log('🎯 שדה טקסט קיבל פוקוס');
                                        setTimeout(updateMonitor, 10);
                                    });
                                }
                            }, 100);
                        }
                    });
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
        
        function stopMonitoring() {
            if (!monitoringActive) return;
            
            monitoringActive = false;
            if (monitorInterval) {
                clearInterval(monitorInterval);
                monitorInterval = null;
            }
            
            const testDuration = testStartTime ? ((Date.now() - testStartTime) / 1000).toFixed(1) : 0;
            log(`🛑 ניטור הופסק אחרי ${testDuration} שניות`);
        }
        
        function selectTestText() {
            const highlights = testContent.querySelectorAll('.highlight');
            if (highlights.length > 0) {
                const range = document.createRange();
                range.selectNode(highlights[0]);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                log('👆 טקסט נבחר אוטומטית');
            }
        }
        
        function clearSelection() {
            window.getSelection().removeAllRanges();
            log('🧹 בחירה נוקתה');
        }
        
        // Auto-start monitoring
        document.addEventListener('DOMContentLoaded', () => {
            log('🚀 בדיקה קריטית אותחלה');
            log('📋 בחר טקסט ופתח דיאלוג Better Me');
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                log('✅ תוסף Better Me זמין');
            } else {
                log('❌ תוסף Better Me לא זמין');
            }
            
            startMonitoring();
            updateMonitor();
        });
        
        // Monitor selection changes
        document.addEventListener('selectionchange', updateMonitor);
    </script>
</body>
</html>
